#!/bin/bash
# Pre-commit hook para prevenir subida de solucionarios confidenciales
# Este script se ejecuta automÃ¡ticamente antes de cada commit

# Colores para output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Verificar si hay archivos de solucionarios en el staging area
SOLUCIONARIOS=$(git diff --cached --name-only | grep -E "(solucionario|instructor-notes|notas-instructor)")

if [ -n "$SOLUCIONARIOS" ]; then
    echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${RED}âŒ ERROR: INTENTO DE COMMIT DE ARCHIVOS CONFIDENCIALES${NC}"
    echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "${YELLOW}Los siguientes archivos son CONFIDENCIALES y NO deben subirse a GitHub:${NC}"
    echo ""
    echo "$SOLUCIONARIOS" | while read -r file; do
        echo "  ğŸ”’ $file"
    done
    echo ""
    echo "${YELLOW}Â¿Por quÃ© se bloqueÃ³ este commit?${NC}"
    echo "  â€¢ Los solucionarios contienen respuestas correctas de los bugs"
    echo "  â€¢ Solo los instructores deben tener acceso"
    echo "  â€¢ Los estudiantes no deben ver las soluciones antes de intentarlo"
    echo ""
    echo "${YELLOW}Â¿QuÃ© hacer?${NC}"
    echo "  1. Quita estos archivos del staging area:"
    echo "     ${YELLOW}git reset HEAD <archivo>${NC}"
    echo ""
    echo "  2. Verifica que estÃ©n en .gitignore:"
    echo "     ${YELLOW}cat .gitignore | grep solucionario${NC}"
    echo ""
    echo "  3. Si necesitas los archivos localmente, guÃ¡rdalos pero NO los commitees"
    echo ""
    echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${RED}Commit bloqueado para proteger informaciÃ³n confidencial${NC}"
    echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    exit 1
fi

# Verificar si hay archivos de _docs/instructor/ en staging
INSTRUCTOR_DOCS=$(git diff --cached --name-only | grep "_docs/instructor/")

if [ -n "$INSTRUCTOR_DOCS" ]; then
    echo "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${YELLOW}âš ï¸  ADVERTENCIA: Archivos del directorio instructor${NC}"
    echo "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "EstÃ¡s a punto de commitear archivos de la carpeta instructor:"
    echo ""
    echo "$INSTRUCTOR_DOCS" | while read -r file; do
        echo "  ğŸ“„ $file"
    done
    echo ""
    echo "${YELLOW}Â¿Estos archivos son seguros para subir a GitHub?${NC}"
    echo "  â€¢ Los solucionarios NO deben subirse (confidenciales)"
    echo "  â€¢ La metodologÃ­a de bugs SÃ puede subirse (es pÃºblica para instructores)"
    echo "  â€¢ Los templates SÃ pueden subirse (los estudiantes los necesitan)"
    echo ""
    read -p "Â¿Continuar con el commit? (y/N): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo ""
        echo "${RED}Commit cancelado por el usuario${NC}"
        echo ""
        exit 1
    fi
fi

# Si llegamos aquÃ­, el commit es seguro
exit 0
